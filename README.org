#+TITLE: amp.el
#+AUTHOR: Keegan Carruthers-Smith
#+AUTHOR: Amp <amp@ampcode.com>

An unofficial Emacs client for Amp's IDE mode.

Ported from [[https://github.com/sourcegraph/amp.nvim][amp.nvim]]. Inspired by [[https://github.com/manzaltu/claude-code-ide.el][claude-code-ide.el]].

* Status

Complete rewrite based on amp.nvim architecture. Actively dogfooding and will
publish a proper version (likely on the Sourcegraph org) at some point.

Do not trust this documentation yet, it was written by Amp and not validated
by a human yet.

Implements the same IDE protocol as amp.nvim, providing:
- Selection tracking (cursor position and visual regions)
- Visible files tracking across windows
- File read/edit operations
- Pull-based diagnostics (via Flymake/eglot)
- Message sending to Amp agent

* Usage

1. Install and load the package:
#+begin_src elisp
;; Add to load-path and load
(add-to-list 'load-path "/path/to/directory/containing/amp.el")
(require 'amp)
#+end_src

2. Start the Amp server:
#+begin_src elisp
M-x amp-start
#+end_src

Or enable the global minor mode =amp-mode= for automatic startup:
#+begin_src elisp
(amp-mode 1)
#+end_src

3. Launch Amp in another terminal:
#+begin_src shell
amp --ide
#+end_src

4. Open a file and move your cursor - Amp will track your selection automatically.

* What Works

- WebSocket server with lockfile-based discovery
  - Binds to localhost only on a random port (10000-65535)
  - Lockfile location: =$AMP_DATA_HOME/amp/ide/<port>.json= (or =$XDG_DATA_HOME/amp/ide/<port>.json=, defaults to =~/.local/share/amp/ide/<port>.json=)
  - Lockfile contains: port, authToken, pid, workspaceFolders, ideName
  - On connect, sends initial state (visible files, selection) and pluginMetadata
- Selection tracking (cursor and visual regions, debounced updates)
- Visible files tracking across all windows
- File reading and editing via Amp (editFile uses fullContent replacement)
- Pull-based diagnostics via Flymake (integrates with eglot/LSP)
  - Supports getDiagnostics requests for files or directories
- Message sending (userSentMessage, appendToPrompt)
- Automatic cleanup on Emacs exit

* What Doesn't

- Authentication (auth token generated but not validated - authenticate always succeeds)
- Multiple workspace folders (currently hardcoded to ["/"])

* Requirements

- Emacs 28.1+
- =websocket= package (1.12+)
- Amp CLI that supports =--ide= flag

Install the websocket package:
#+begin_src elisp
M-x package-install RET websocket RET
#+end_src

* Commands

| Command              | Purpose                                    |
|----------------------+--------------------------------------------|
| =amp-start=          | Start Amp WebSocket server                 |
| =amp-stop=           | Stop Amp WebSocket server                  |
| =amp-status=         | Show server status and connection info     |
| =amp-send-message=   | Send a message to the Amp agent            |
| =amp-send-region=    | Send selected region to Amp agent          |
| =amp-send-to-prompt= | Append text to Amp prompt field            |
| =amp-mode=           | Toggle global Amp mode (auto-start server) |

* Configuration

#+begin_src elisp
;; Customize log level (trace, debug, info, warn, error)
(setq amp-log-level 'info)

;; Enable amp-mode globally (automatically starts server)
(amp-mode 1)
#+end_src

* Debugging

View logs in the =*amp-log*= buffer to see connection status, selection changes,
and any errors. The log level can be controlled via =amp-log-level=.
